import streamlit as st
import time

# --- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ---
# (Class 4) Import "‡∏™‡∏°‡∏≠‡∏á" (Agent) ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å Class 3
# ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ import 2 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô agent.py
from agent import get_agent_executor, run_agent
# ------------------------------

# === 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (Page Config) ===
st.set_page_config(
    page_title="WEO RAG Chatbot",
    page_icon="ü§ñ",
    layout="centered" 
)

st.title("WEO RAG Chatbot ü§ñ")
st.caption("Chatbot ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ WEO (April 2024) - ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ Gemini")

# === 2. ‡πÇ‡∏´‡∏•‡∏î Agent (‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ===
# (Class 4, Slide 11)
# @st.cache_resource ‡∏Ñ‡∏∑‡∏≠ "‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå" ‡∏Ç‡∏≠‡∏á Streamlit
# ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ô‡πÅ‡∏Ñ‡πà "‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å" ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ
# ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Agent ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà User ‡∏û‡∏¥‡∏°‡∏û‡πå
@st.cache_resource
def load_agent():
    # TODO: (Class 4) ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á
    # """
    # ‡πÇ‡∏´‡∏•‡∏î Agent (‡∏à‡∏≤‡∏Å agent.py) ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Cache
    # """
    # print("--- (App) ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Agent... (‡∏£‡∏±‡∏ô‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ---")
    
    # TODO: (Class 4) ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á
    # ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≤‡∏Å agent.py
    
    # agent = get_agent_executor()
    # return agent
    return None # (‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ)

# TODO: (Class 4) ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á
# agent = load_agent()

# === 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Chat History (Session State) ===
# (Class 4, Slide 10)
# Streamlit ‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" ‡∏ó‡∏µ‡πà User ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á
# ‡πÄ‡∏£‡∏≤‡∏à‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó" (messages) ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô st.session_state
# ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô "‡∏à‡∏≥" ‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡πâ‡∏≤‡∏á

# TODO: (Class 4) ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á
# if "messages" not in st.session_state:
#     st.session_state.messages = []

# === 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Chat History ===
# ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó" ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
# TODO: (Class 4) ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô uncomment 4 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á
# for message in st.session_state.messages:
#     with st.chat_message(message["role"]): # (role: "user" ‡∏´‡∏£‡∏∑‡∏≠ "assistant")
#         st.markdown(message["content"])

# === 5. ‡∏£‡∏±‡∏ö Input ‡∏à‡∏≤‡∏Å User ===
# (Class 4, Slide 9)
# st.chat_input ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á "‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó" ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏≠
if prompt := st.chat_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö WEO ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."):
    
    # TODO: (Class 4, Slide 11) ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô uncomment ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    # (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á Class 4)
    
    # --- 5.1 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Agent ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ---
    # if agent is None:
    #     st.error("Agent ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥ TODO ‡πÉ‡∏ô app.py ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à")
    # else:
    #     # --- 5.2 ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á User ‡∏ö‡∏ô‡∏à‡∏≠ ---
    #     st.session_state.messages.append({"role": "user", "content": prompt})
    #     with st.chat_message("user"):
    #         st.markdown(prompt)

    #     # --- 5.3 ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Agent (‡∏à‡∏≤‡∏Å agent.py) ---
    #     with st.chat_message("assistant"):
    #         # "Spinner" ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á animation "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."
    #         with st.spinner("ü§ñ WEO Agent ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏¥‡∏î..."):
                
    #             # (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!) ‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 'run_agent' 
    #             # ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô agent.py
    #             # ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á 'verbose=False' 
    #             # (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ log ‡∏Ç‡∏≠‡∏á Agent ‡πÑ‡∏õ‡∏õ‡∏ô‡∏Å‡∏±‡∏ö UI)
                
    #             response_dict = run_agent(agent, prompt, verbose=True)
    #             response_text = response_dict['output']
                
    #             # (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô) ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
    #             # time.sleep(1) 
                
    #             # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á Bot
    #             st.markdown(response_text)
        
    #     # --- 5.4 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á Bot ‡∏•‡∏á History ---
    #     st.session_state.messages.append({"role": "assistant", "content": response_text})
    
    # (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Starter: ‡πÅ‡∏™‡∏î‡∏á TODO)
    st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î `app.py` ‡πÅ‡∏•‡∏∞ uncomment ‡∏™‡πà‡∏ß‡∏ô `TODO`")
    pass